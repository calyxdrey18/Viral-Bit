<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViralBit Pro | Elite Messaging</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #3b82f6;
            --bg-dark: #08080a;
            --glass-footer: rgba(10, 10, 15, 0.9);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #050505;
            color: #fff; 
            overflow: hidden; 
            height: 100vh;
        }
        
        /* Glassmorphism */
        .glass { background: rgba(20, 20, 25, 0.7); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.08); }
        
        /* FOOTER & INPUT UI */
        .footer-zone {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px; /* High footer base */
            background: linear-gradient(to top, var(--bg-dark) 60%, transparent);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding-bottom: 20px;
        }

        .floating-input-container {
            width: 90%;
            max-width: 800px;
            background: rgba(30, 30, 35, 0.8);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 2rem;
            padding: 8px 10px 8px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            transform: translateY(-10px); /* Lifts it higher */
        }

        .send-btn-elite {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            width: 50px;
            height: 50px;
            border-radius: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 15px rgba(59, 130, 246, 0.4);
        }
        .send-btn-elite:hover {
            transform: scale(1.1) rotate(-5deg);
            box-shadow: 0 12px 25px rgba(59, 130, 246, 0.6);
        }

        /* Pulse for New Messages */
        .pulse-active {
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border-radius: 50%;
            position: absolute;
            top: 0;
            right: 0;
            border: 2px solid #08080a;
            animation: pulse-ring 1.5s infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Scrolling Area Fixes */
        .scrollable-content {
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            padding-bottom: 140px !important; /* Forces content above footer */
        }
        .scrollable-content::-webkit-scrollbar { display: none; }

        .bubble { 
            max-width: 75%; 
            padding: 14px 18px; 
            border-radius: 22px; 
            font-size: 14px; 
            margin-bottom: 4px;
        }
        .bubble-out { background: #2563eb; align-self: flex-end; border-bottom-right-radius: 4px; }
        .bubble-in { background: #1f1f23; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }

        .google-btn {
            background: white;
            color: black;
            font-weight: 700;
            transition: 0.3s;
        }
        .google-btn:hover { background: #f3f4f6; transform: translateY(-2px); }
    </style>
</head>
<body class="flex">

    <div id="auth-screen" class="fixed inset-0 z-[200] flex items-center justify-center bg-[#050505]">
        <div class="glass p-10 rounded-[3rem] w-full max-w-md text-center shadow-2xl border-white/10">
            <img src="https://res.cloudinary.com/dgy2dutjs/image/upload/v1768048743/url.crissvevo.co.tz/1000940115_wqb0mf.jpg" class="w-20 h-20 mx-auto rounded-3xl mb-6 shadow-xl border border-blue-500/30">
            <h1 class="text-3xl font-black mb-8 italic">VIRALBIT <span class="text-blue-500">PRO</span></h1>
            
            <div class="space-y-4">
                <button onclick="loginWithGoogle()" class="google-btn w-full py-4 rounded-2xl flex items-center justify-center gap-3 shadow-lg">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5">
                    Continue with Google
                </button>
                <div class="text-zinc-600 text-[10px] font-bold uppercase tracking-widest py-2">Secure Gateway</div>
                <input id="email" type="email" placeholder="Email" class="w-full bg-zinc-900 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500 border border-white/5">
                <input id="password" type="password" placeholder="Password" class="w-full bg-zinc-900 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500 border border-white/5">
                <button onclick="handleAuth()" class="w-full bg-blue-600 py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/20">Sign In</button>
            </div>
        </div>
    </div>

    <div id="app" class="hidden flex h-screen w-full">
        <div id="sidebar" class="w-full md:w-[380px] flex flex-col glass border-r border-white/5">
            <div class="p-8 pb-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black">Messages</h2>
                    <button onclick="logout()" class="text-zinc-500 hover:text-red-500"><i class="fas fa-power-off"></i></button>
                </div>
                
                <div class="flex bg-zinc-900/80 p-1 rounded-xl mb-4">
                    <button id="tab-all" onclick="toggleTab('all')" class="flex-1 py-2.5 text-xs font-bold rounded-lg bg-blue-600 text-white transition">All Chats</button>
                    <button id="tab-new" onclick="toggleTab('new')" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-zinc-500 transition">Unread</button>
                </div>
            </div>

            <div id="chat-list" class="flex-grow scrollable-content px-4 space-y-2">
                </div>
        </div>

        <div id="chat-window" class="hidden md:flex flex-grow flex-col relative bg-[#08080a]">
            <div class="p-6 glass border-b border-white/5 flex items-center gap-4 z-50">
                <button onclick="closeChat()" class="md:hidden text-zinc-400"><i class="fas fa-chevron-left"></i></button>
                <div id="header-avatar" class="w-12 h-12 rounded-xl bg-blue-600 flex items-center justify-center font-bold text-white shadow-lg">?</div>
                <div>
                    <h3 id="header-name" class="font-bold text-lg leading-tight">Conversation</h3>
                    <span class="text-[10px] text-green-500 font-bold uppercase tracking-wider">‚óè Online</span>
                </div>
            </div>

            <div id="message-feed" class="flex-grow scrollable-content p-8 flex flex-col gap-4">
                </div>

            <div id="footer-controls" class="footer-zone hidden">
                <form id="chat-form" class="floating-input-container">
                    <button type="button" class="text-zinc-500 hover:text-white transition px-2"><i class="fas fa-plus-circle text-xl"></i></button>
                    <input id="chat-input" type="text" autocomplete="off" placeholder="Start typing..." 
                           class="flex-grow bg-transparent border-none outline-none py-3 px-4 text-sm text-white placeholder-zinc-500">
                    <button type="submit" class="send-btn-elite">
                        <i class="fas fa-paper-plane text-white text-lg"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, onSnapshot, addDoc, serverTimestamp, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhik0XXwNiC-6PhLeEoif0ER2zMEH8uqY",
            authDomain: "viralbit-pro.firebaseapp.com",
            projectId: "viralbit-pro",
            storageBucket: "viralbit-pro.firebasestorage.app",
            messagingSenderId: "265912822122",
            appId: "1:265912822122:web:b75b143009aae11f025d13"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let me = null;
        let activeTab = 'all';
        let activeChatId = null;

        window.loginWithGoogle = async () => {
            const res = await signInWithPopup(auth, googleProvider);
            const userDoc = { uid: res.user.uid, username: res.user.displayName.split(' ')[0].toLowerCase(), email: res.user.email };
            await setDoc(doc(db, "users", res.user.uid), userDoc, { merge: true });
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const d = await getDoc(doc(db, "users", user.uid));
                me = d.data();
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadDirectory();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app').classList.add('hidden');
            }
        });

        window.toggleTab = (tab) => {
            activeTab = tab;
            document.getElementById('tab-all').className = tab === 'all' ? "flex-1 py-2.5 text-xs font-bold rounded-lg bg-blue-600 text-white" : "flex-1 py-2.5 text-xs font-bold rounded-lg text-zinc-500";
            document.getElementById('tab-new').className = tab === 'new' ? "flex-1 py-2.5 text-xs font-bold rounded-lg bg-blue-600 text-white" : "flex-1 py-2.5 text-xs font-bold rounded-lg text-zinc-500";
            loadDirectory();
        };

        function loadDirectory() {
            const list = document.getElementById('chat-list');
            onSnapshot(collection(db, "users"), (userSnap) => {
                const chatQuery = query(collection(db, "chats"), where("members", "array-contains", me.uid));
                onSnapshot(chatQuery, (chatSnap) => {
                    list.innerHTML = '';
                    const myChats = {};
                    chatSnap.forEach(c => myChats[c.id] = c.data());

                    userSnap.forEach(uDoc => {
                        const user = uDoc.data();
                        if (user.uid === me.uid) return;

                        const chatId = me.uid < user.uid ? `${me.uid}_${user.uid}` : `${user.uid}_${me.uid}`;
                        const chatData = myChats[chatId];
                        const isNew = chatData && chatData.lastMsg && chatData.lastMsg.senderId !== me.uid && !chatData.lastMsg.read;

                        if (activeTab === 'new' && !isNew) return;

                        const div = document.createElement('div');
                        div.className = "p-4 flex items-center gap-4 rounded-2xl cursor-pointer hover:bg-white/5 transition-all";
                        div.innerHTML = `
                            <div class="relative">
                                <div class="w-12 h-12 bg-zinc-900 rounded-xl flex items-center justify-center font-bold text-blue-500 border border-white/5">
                                    ${user.username[0].toUpperCase()}
                                </div>
                                ${isNew ? '<div class="pulse-active"></div>' : ''}
                            </div>
                            <div class="flex-grow min-w-0">
                                <h4 class="font-bold text-sm truncate">@${user.username}</h4>
                                <p class="text-[11px] truncate ${isNew ? 'text-blue-400 font-bold' : 'text-zinc-500'}">
                                    ${chatData && chatData.lastMsg ? chatData.lastMsg.text : 'Click to secure chat'}
                                </p>
                            </div>
                        `;
                        div.onclick = () => openChat(user, chatId);
                        list.appendChild(div);
                    });
                });
            });
        }

        async function openChat(target, chatId) {
            activeChatId = chatId;
            document.getElementById('active-chat-ui'); // Note: Reusing UI elements
            document.getElementById('chat-window').classList.remove('hidden');
            document.getElementById('footer-controls').classList.remove('hidden');
            if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
            
            document.getElementById('header-name').innerText = `@${target.username}`;
            document.getElementById('header-avatar').innerText = target.username[0].toUpperCase();

            await setDoc(doc(db, "chats", chatId), {
                members: [me.uid, target.uid],
                userData: [me, target],
                updatedAt: serverTimestamp()
            }, { merge: true });

            await updateDoc(doc(db, "chats", chatId), { "lastMsg.read": true });

            onSnapshot(query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc")), (snap) => {
                const feed = document.getElementById('message-feed');
                feed.innerHTML = '';
                snap.forEach(m => {
                    const msg = m.data();
                    const isMe = msg.senderId === me.uid;
                    const bubble = document.createElement('div');
                    bubble.className = `bubble ${isMe ? 'bubble-out' : 'bubble-in shadow-xl'}`;
                    bubble.innerText = msg.text;
                    feed.appendChild(bubble);
                });
                feed.scrollTop = feed.scrollHeight;
            });
        }

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !activeChatId) return;
            input.value = '';

            await addDoc(collection(db, "chats", activeChatId, "messages"), { text, senderId: me.uid, timestamp: serverTimestamp() });
            await updateDoc(doc(db, "chats", activeChatId), { lastMsg: { text, senderId: me.uid, read: false }, updatedAt: serverTimestamp() });
        };

        window.logout = () => signOut(auth);
        window.closeChat = () => {
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('chat-window').classList.add('hidden');
        };
    </script>
</body>
</html>
